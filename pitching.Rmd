Author: Trey Chase
Date: sys.date()


```{r loading packages, echo=FALSE, warning= FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(GGally)
library(stats)
library(rsample)
library(tidyverse)
```


```{r loading data}
df <- read_csv("/Users/treychase/Downloads/poi_metrics.csv")
```
```{r df structure}
dim(df)
head(df)
summary(df)
```

```{r data selection}
#obtaining all quantitative variables, dropping all rows with na
q_df = df |>
  select_if(
    is.numeric, 
  ) |>
  drop_na() |>
  select(
    -(session) #removing session column
  )
```


```{r correlation plot, echo=FALSE}
#checking multi collinearity condition, as well as obtaining the most correlated value with pitch speed
library(ggcorrplot)
corr_matrix = cor(q_df)
diag(corr_matrix) = NA

first_column <- corr_matrix[,1] #looking at the pitch speed column
max_value <- max(first_column, na.rm = TRUE) #finding the maximum correlated variable with pitch speed
max_var <- rownames(corr_matrix)[which(first_column == max_value)]


max_value
max_var
```

```{r correlation plot}
cor_plot = ggcorrplot(corr_matrix) 
ggsave("dl_corr_plot.png", plot = cor_plot, width = 30, height = 30)
```
Saving the correlation plot to examine which variables are correlated with pitch speed.

```{r velocity distribution}
ggplot(q_df, aes(x = pitch_speed_mph)) +
  geom_histogram(aes(y = ..density..), binwidth = 1, color = "white", fill = "blue", alpha = 0.7) +
  geom_density(color = "orange", size = 1) +
  labs(x = "Pitch Speed (MPH)",
       y = "Density",
       title = "Histogram of Pitch Speed with Estimated Density Curve")
```

We can see that the distribution of pitch speeds are slightly skewed left but approximately normal.


```{r splitting data}
set.seed(123)  # For reproducibility
split <- initial_split(q_df, prop = 0.8) #splitting data into test and training data
train_df <- training(split)
test_df <- testing(split)
```

This step-wise regression will start by constructing regression models with all variables present, and will iterate and remove one variable based on the lowest AIC of the models.

```{r stepwise regression and choosing model}
lm_mod = lm(pitch_speed_mph ~., data=train_df)
selected_mod = step(lm_mod)
summary(selected_mod)
```
```{r vifs}
library(car)
vifs = car::vif(selected_mod)
print(vifs)
```


Recursively remove VIFs > 4 to ensure the multi-collinearity check is confirmed.

```{r removing high vif EVs}
signif_all <- names(vifs)

while(any(vifs >= 10)) {  # while any of the vifs have a value greater than 10
  var_with_max_vif <- names(which.max(vifs))  # get the var with max vif
  signif_all <- signif_all[!signif_all %in% var_with_max_vif]  # remove
  myForm <- as.formula(paste("pitch_speed_mph ~ ", paste(signif_all, collapse=" + "), sep=""))  # new formula
  selected_mod <- lm(myForm, data=train_df)  # re-build model with new formula
  vifs <- car::vif(selected_mod)  # update VIFs
}

summary(selected_mod)

```

Multicollinearity has been removed. Now we need to remove the variables in the model that are not statistically significant from the t-test.

```{r removing not statistically  significant variables}
all_vars <- names(selected_mod[[1]])[-1]  # names of all X variables
# Get the non-significant vars
summ <- summary(selected_mod)  # model summary
pvals <- summ[[4]][, 4]  # get all p values
not_significant <- character()  # init variables that aren't statistically significant
not_significant <- names(which(pvals > 0.05))
not_significant <- not_significant[!not_significant %in% "(Intercept)"]  # remove 'intercept'. Optional!

# If there are any non-significant variables, 
while(length(not_significant) > 0){
  all_vars <- all_vars[!all_vars %in% not_significant[1]]
  myForm <- as.formula(paste("pitch_speed_mph ~ ", paste (all_vars, collapse=" + "), sep=""))  # new formula
  selected_mod <- lm(myForm, data=train_df)  # re-build model with new formula
  
  # Get the non-significant vars.
  summ <- summary(selected_mod)
  pvals <- summ[[4]][, 4]
  not_significant <- character()
  not_significant <- names(which(pvals > 0.1))
  not_significant <- not_significant[!not_significant %in% "(Intercept)"]
}
summary(selected_mod)
```

Multi-collinearity and statistical significance (p < 0.05) have been confirmed.


```{r plots of the model}
plot(selected_mod)
```


```{r predicting values}
predict_df = predict(selected_mod, test_df, level = 0.95, interval = "predict")
```


```{r adding to the test df}
head(test_df)

```


